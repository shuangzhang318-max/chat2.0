<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å†…éƒ¨èŠå¤©å®¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { --blue:#1677ff; --bg:#f6f7f9; --card:#fff; --text:#1f2328; --muted:#8c8c8c; --border:#e6e6e6; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow: hidden; }
    header{ background:var(--blue); color:#fff; padding:12px 14px; display:flex; align-items:center; justify-content:space-between; font-weight:700; z-index: 10; }
    header small{ font-weight:500; opacity:.8; font-size: 11px; }

    #wrap{ flex:1; display:flex; flex-direction:column; padding:12px; gap:10px; min-height:0; position: relative; }
    
    /* ç”¨æˆ·ç™»å½•é¢æ¿ */
    #authOverlay { position: absolute; inset: 0; background: var(--bg); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .auth-card { background: #fff; width: 100%; max-width: 360px; padding: 24px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .auth-card h2 { margin: 0 0 20px; font-size: 18px; text-align: center; color: var(--blue); }
    .auth-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
    .auth-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-size: 14px; color: var(--muted); border-bottom: 2px solid transparent; }
    .auth-tab.active { color: var(--blue); border-color: var(--blue); font-weight: bold; }
    .auth-form { display: flex; flex-direction: column; gap: 12px; }
    .auth-form input { padding: 10px; border: 1px solid var(--border); border-radius: 8px; outline: none; }
    .auth-form input:focus { border-color: var(--blue); }

    /* ç®¡ç†é¢æ¿ */
    #adminPanel { background:#fff; border:1px solid #ffe58f; border-radius:10px; padding:12px; display:none; flex-direction:column; gap:10px; margin-bottom:10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    #adminPanel h3 { margin: 0; font-size: 14px; color: #856404; display: flex; justify-content: space-between; align-items: center; }
    
    .admin-auth-box { display: flex; flex-direction: column; gap: 8px; }
    .admin-content { display: none; flex-direction: column; gap: 10px; }
    
    #inviteHistory { max-height: 120px; overflow-y: auto; border: 1px solid #f0f0f0; border-radius: 6px; background: #fafafa; padding: 5px; }
    .history-item { font-size: 12px; padding: 6px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .history-item .info { display: flex; flex-direction: column; min-width: 0; flex: 1; }
    .history-item .room-n { font-weight: bold; color: var(--blue); }
    .history-item .code-n { color: var(--muted); font-size: 11px; }
    .btn-copy { font-size: 10px; padding: 2px 6px; background: #eee; border-radius: 4px; cursor: pointer; flex: 0 0 auto; }

    #status{ background:var(--card); border:1px solid var(--border); border-radius:10px; padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px; }
    #badge{ width:10px; height:10px; border-radius:999px; background:#ff4d4f; }
    #whoami{ font-size:13px; color:#fff; background:var(--blue); padding:6px 10px; border-radius:999px; }

    #chat{ flex:1; min-height:0; overflow-y:auto; background:var(--card); border:1px solid var(--border); border-radius:10px; padding:12px; }
    .msg{ display:flex; gap:10px; margin-bottom:10px; align-items:flex-start; }
    .avatar{ width:34px; height:34px; border-radius:999px; background:#e9f2ff; border:1px solid #d6e7ff; color:var(--blue);
      display:flex; align-items:center; justify-content:center; font-weight:800; flex:0 0 auto; }
    .bubble{ max-width:82%; background:#f7f7f7; border:1px solid var(--border); border-radius:12px; padding:8px 10px; line-height:1.35; word-break:break-word; }
    .meta { font-size:12px; color:var(--muted); margin-bottom:4px; display:flex; gap:8px; align-items:baseline; }
    .text { font-size:14px; white-space:pre-wrap; }
    .me { flex-direction: row-reverse; }
    .me .meta { flex-direction: row-reverse; }
    .me .avatar { background:var(--blue); color:#fff; }
    .me .bubble { background:#e8f1ff; border-color:#cfe1ff; }
    .sys { margin:10px 0; text-align:center; color:var(--muted); font-size:12px; }

    footer{ background:var(--card); border:1px solid var(--border); border-radius:10px; padding:10px; display:flex; gap:8px; align-items:center; }
    #msgInput{ flex:1; padding:10px; font-size:14px; border:1px solid var(--border); border-radius:10px; outline:none; }
    .btn{ padding:10px 12px; font-size:14px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    .btn.primary{ background:var(--blue); color:#fff; border-color:var(--blue); font-weight:700; }
    .btn.sm { padding: 4px 8px; font-size: 11px; }
    #viewer{ position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:9999; }
    #viewer img{ max-width:96vw; max-height:90vh; border-radius:12px; }
  </style>
</head>

<body>
<header>
  <div>å†…éƒ¨èŠå¤©å®¤</div>
  <small id="roomTag">CID: -</small>
</header>

<div id="wrap">
  <!-- ç™»å½•æ³¨å†Œé®ç½© -->
  <div id="authOverlay">
    <div class="auth-card">
      <h2 id="authTitle">ç”¨æˆ·ç™»å½•</h2>
      <div class="auth-tabs">
        <div class="auth-tab active" id="tabLogin">ç™»å½•</div>
        <div class="auth-tab" id="tabSignup">æ³¨å†Œè´¦å·</div>
      </div>
      <div class="auth-form">
        <input type="text" id="authUsername" placeholder="æ˜µç§° / è´¦å·" />
        <input type="password" id="authPassword" placeholder="å¯†ç " />
        <button class="btn primary" id="doAuth">ç«‹å³è¿›å…¥</button>
      </div>
      <p id="authMsg" style="font-size: 12px; color: #ff4d4f; margin-top: 10px; text-align: center;"></p>
    </div>
  </div>

  <!-- ç®¡ç†é¢æ¿ -->
  <div id="adminPanel">
    <h3>
      <span>ğŸ› ï¸ ç®¡ç†æ§åˆ¶å°</span>
      <button class="btn sm" id="adminLogout" style="display:none">é€€å‡ºç®¡ç†</button>
    </h3>
    <div id="adminAuth" class="admin-auth-box">
      <input type="password" id="adminSecret" placeholder="è¾“å…¥ç®¡ç†å¯†é’¥" />
      <button class="btn primary" id="doAdminLogin">ç™»å½•ç®¡ç†åå°</button>
    </div>
    <div id="adminMain" class="admin-content">
      <div style="display:flex; gap:8px;">
        <input type="text" id="newRoomName" placeholder="æ–°æˆ¿é—´å" style="flex:1" />
        <button class="btn primary" id="doCreateRoom">ç”Ÿæˆ</button>
      </div>
      <div id="inviteHistory">åŠ è½½å†å²ä¸­...</div>
    </div>
  </div>

  <div id="status">
    <div class="left">
      <div id="badge"></div>
      <div id="statusText">æ­£åœ¨åˆå§‹åŒ–...</div>
    </div>
    <div style="display:flex; gap:6px; align-items:center;">
      <button class="btn sm" style="display:none;" id="toggleAdmin">ç®¡ç†</button>
      <button class="btn sm" id="userLogout">é€€å‡ºç™»å½•</button>
      <div id="whoami">-</div>
    </div>
  </div>

  <div id="chat"></div>

  <footer>
    <button class="btn icon" id="pickBtn">ğŸ–¼ï¸</button>
    <input id="msgInput" type="text" placeholder="è¾“å…¥æ¶ˆæ¯â€¦" />
    <button class="btn primary" id="sendBtn">å‘é€</button>
    <input id="imgInput" type="file" accept="image/*" style="display:none" />
  </footer>
</div>

<div id="viewer" onclick="this.style.display='none'"><img id="viewerImg" src=""></div>

<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4/dist/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leancloud-realtime@5.0.0-rc.8/dist/im-browser.min.js"></script>

<script>
/* ========== åˆå§‹åŒ– ========== */
const APP_ID = "cf8fIUbJ0JZQmYfiihY6B1Fv-MdYXbMMI";
const APP_KEY = "UgnyTX8j3XGlfHPyGqPxgEB5";
const SERVER_URL = "https://cf8fiubj.api.lncldglobal.com";

// âœ… ä¿®å¤ï¼šå¢åŠ  guard åˆ¤æ–­ï¼Œé˜²æ­¢é‡å¤åˆå§‹åŒ–æŠ¥é”™
if (!AV.applicationId) {
  AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });
}

const API_BASE = "https://chat-xyjdzs.avosapps.us";

/* ========== çŠ¶æ€å˜é‡ ========== */
const qs = new URLSearchParams(location.search);
const inviteCode = qs.get("invite") || "";
const isAdminMode = qs.get("admin") === "1";
let authMode = "login"; 

let client = null, conversation = null, myClientId = "";
let currentAdminSecret = "";

/* ========== DOM å¼•ç”¨ ========== */
const authOverlay = document.getElementById("authOverlay");
const authUsernameInput = document.getElementById("authUsername");
const authPasswordInput = document.getElementById("authPassword");
const doAuthBtn = document.getElementById("doAuth");
const authMsg = document.getElementById("authMsg");
const chatEl = document.getElementById("chat");
const whoamiEl = document.getElementById("whoami");

const adminPanel = document.getElementById("adminPanel");
const toggleAdminBtn = document.getElementById("toggleAdmin");
const adminAuthBox = document.getElementById("adminAuth");
const adminMainBox = document.getElementById("adminMain");
const adminSecretInput = document.getElementById("adminSecret");
const doAdminLoginBtn = document.getElementById("doAdminLogin");
const adminLogoutBtn = document.getElementById("adminLogout");
const newRoomNameInput = document.getElementById("newRoomName");
const doCreateRoomBtn = document.getElementById("doCreateRoom");
const inviteHistoryEl = document.getElementById("inviteHistory");

/* ========== 1. ç”¨æˆ·è®¤è¯é€»è¾‘ ========== */
function updateAuthUI() {
  document.getElementById("authTitle").textContent = authMode === "login" ? "ç”¨æˆ·ç™»å½•" : "æ³¨å†Œæ–°è´¦å·";
  document.getElementById("tabLogin").className = authMode === "login" ? "auth-tab active" : "auth-tab";
  document.getElementById("tabSignup").className = authMode === "signup" ? "auth-tab active" : "auth-tab";
}

document.getElementById("tabLogin").onclick = () => { authMode = "login"; updateAuthUI(); };
document.getElementById("tabSignup").onclick = () => { authMode = "signup"; updateAuthUI(); };

doAuthBtn.onclick = async () => {
  const username = authUsernameInput.value.trim();
  const password = authPasswordInput.value.trim();
  if (!username || !password) return (authMsg.textContent = "è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");

  try {
    doAuthBtn.disabled = true;
    let user;
    if (authMode === "signup") {
      user = new AV.User();
      user.setUsername(username);
      user.setPassword(password);
      await user.signUp();
      authMsg.textContent = "æ³¨å†ŒæˆåŠŸï¼Œæ­£åœ¨ç™»å½•...";
    } else {
      user = await AV.User.logIn(username, password);
    }
    authOverlay.style.display = "none";
    startIM(); 
  } catch (e) {
    authMsg.textContent = "æ“ä½œå¤±è´¥: " + (e.message || e);
  } finally {
    doAuthBtn.disabled = false;
  }
};

document.getElementById("userLogout").onclick = () => {
  AV.User.logOut();
  location.reload();
};

/* ========== 2. ç®¡ç†é€»è¾‘å®ç° ========== */
toggleAdminBtn.onclick = () => {
  const isShow = adminPanel.style.display === "flex";
  adminPanel.style.display = isShow ? "none" : "flex";
};

doAdminLoginBtn.onclick = async () => {
  const secret = adminSecretInput.value;
  if (!secret) return;
  try {
    currentAdminSecret = secret;
    await refreshInviteHistory();
    adminAuthBox.style.display = "none";
    adminMainBox.style.display = "flex";
    adminLogoutBtn.style.display = "block";
    sys("ğŸ”‘ ç®¡ç†åå°å·²ç™»å½•");
  } catch (e) {
    alert("ç™»å½•å¤±è´¥ï¼Œå¯†é’¥ä¸æ­£ç¡®");
    currentAdminSecret = "";
  }
};

adminLogoutBtn.onclick = () => {
  currentAdminSecret = "";
  adminAuthBox.style.display = "flex";
  adminMainBox.style.display = "none";
  adminLogoutBtn.style.display = "none";
  adminSecretInput.value = "";
};

async function refreshInviteHistory() {
  inviteHistoryEl.innerHTML = "æ­£åœ¨æ‹‰å–è®°å½•...";
  const query = new AV.Query('InviteCode');
  query.descending('createdAt');
  query.limit(20);
  try {
    const list = await query.find(); 
    if (list.length === 0) {
      inviteHistoryEl.innerHTML = "æš‚æ— è®°å½•";
      return;
    }
    inviteHistoryEl.innerHTML = "";
    list.forEach(item => {
      const room = item.get('room');
      const code = item.get('code');
      const url = window.location.origin + window.location.pathname + "?invite=" + code;
      const div = document.createElement("div");
      div.className = "history-item";
      div.innerHTML = `
        <div class="info">
          <span class="room-n">${room}</span>
          <span class="code-n">ç : ${code}</span>
        </div>
        <div class="btn-copy" onclick="copyToClipboard('${url}')">å¤åˆ¶</div>
      `;
      inviteHistoryEl.appendChild(div);
    });
  } catch (e) {
    inviteHistoryEl.innerHTML = "åŠ è½½å¤±è´¥æˆ–æ— æƒé™";
    throw e;
  }
}

function copyToClipboard(text) {
  const el = document.createElement('textarea');
  el.value = text;
  document.body.appendChild(el);
  el.select();
  document.execCommand('copy');
  document.body.removeChild(el);
  sys("ğŸ“‹ é‚€è¯·é“¾æ¥å·²å¤åˆ¶");
}

doCreateRoomBtn.onclick = async () => {
  const roomName = newRoomNameInput.value.trim();
  if (!currentAdminSecret || !roomName) return alert("è¯·å¡«å†™æˆ¿é—´å");
  try {
    doCreateRoomBtn.disabled = true;
    const res = await fetch(API_BASE + "/api/invite/create", {
      method: "POST",
      headers: { "Content-Type": "application/json", "x-admin-secret": currentAdminSecret },
      body: JSON.stringify({ room: roomName, ttlMinutes: 129600 })
    });
    if (!res.ok) throw new Error(await res.text());
    sys("âœ¨ æ–°æˆ¿é—´é‚€è¯·å·²ç”Ÿæˆï¼");
    await refreshInviteHistory(); 
    newRoomNameInput.value = "";
  } catch (e) {
    alert("åˆ›å»ºå¤±è´¥: " + e.message);
  } finally {
    doCreateRoomBtn.disabled = false;
  }
};

/* ========== 3. èŠå¤©æ ¸å¿ƒé€»è¾‘ ========== */
async function getRTMSignature() {
  const res = await fetch(API_BASE + "/api/rtm/sign", {
    method: "POST",
    headers: { "Authorization": "Bearer " + window.chatToken, "Content-Type": "application/json" }
  });
  return res.json();
}

async function startIM() {
  const user = AV.User.current();
  if (!user) {
    authOverlay.style.display = "flex";
    return;
  }
  
  myClientId = user.getUsername();
  whoamiEl.textContent = myClientId;
  if (isAdminMode) toggleAdminBtn.style.display = "block";

  if (!inviteCode) {
    document.getElementById("statusText").textContent = "ç­‰å¾…é‚€è¯·...";
    sys("ğŸ‘‹ æ¬¢è¿ï¼è¯·ä½¿ç”¨é‚€è¯·é“¾æ¥è¿›å…¥èŠå¤©å®¤ã€‚");
    return;
  }

  try {
    document.getElementById("statusText").textContent = "è¿æ¥ä¸­...";
    const res = await fetch(API_BASE + "/api/invite/redeem", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code: inviteCode, name: myClientId })
    });
    if (!res.ok) throw new Error("é‚€è¯·éªŒè¯å¤±è´¥");
    const redeem = await res.json();
    window.chatToken = redeem.chatToken;

    const Realtime = (window.AV && window.AV.Realtime) || window.Realtime;
    const realtime = new Realtime({ appId: APP_ID, appKey: APP_KEY, server: SERVER_URL, auth: getRTMSignature });
    client = await realtime.createIMClient(myClientId);

    const query = client.getQuery().equalTo('name', redeem.room);
    const results = await query.find();
    conversation = results.length > 0 ? results[0] : await client.createConversation({ name: redeem.room, unique: false });
    
    await conversation.join();
    document.getElementById("roomTag").textContent = "Room: " + redeem.room;
    document.getElementById("statusText").textContent = "åœ¨çº¿";
    document.getElementById("badge").style.background = "#52c41a";

    client.on("message", (m, conv) => {
      if (conv.id === conversation.id && m.from !== myClientId && m.text) {
        addMsg({ from: m.from, time: m.timestamp, text: m.text });
      }
    });

    const msgs = await conversation.queryMessages({ limit: 20 });
    msgs.forEach(m => { if (m.text) addMsg({ from: m.from, time: m.timestamp, text: m.text }); });

  } catch (e) {
    // âœ… ä¿®å¤ï¼šå¦‚æœæŠ¥é”™æ˜¯å› ä¸ºé‡å¤åˆå§‹åŒ–ï¼Œæˆ‘ä»¬å¿½ç•¥å®ƒç»§ç»­é€»è¾‘ï¼Œæˆ–è€…å‹å¥½çš„å±•ç¤º
    if (e.message && e.message.includes("already initialized")) {
       console.warn("LeanCloud App already initialized, skipping init.");
    } else {
       document.getElementById("statusText").textContent = "é”™è¯¯: " + e.message;
    }
  }
}

function sys(text) {
  const div = document.createElement("div");
  div.className = "sys";
  div.textContent = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function addMsg({ from, time, text }) {
  const d = new Date(time || Date.now());
  const tStr = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  const row = document.createElement("div");
  row.className = "msg" + (from === myClientId ? " me" : "");
  row.innerHTML = `
    <div class="avatar">${from[0].toUpperCase()}</div>
    <div class="bubble">
      <div class="meta"><span>${from}</span><span>${tStr}</span></div>
      <div class="text">${text}</div>
    </div>
  `;
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

async function send() {
  const text = document.getElementById("msgInput").value.trim();
  if (!text || !conversation) return;
  document.getElementById("msgInput").value = "";
  try {
    const TextMessage = (window.AV && window.AV.TextMessage) || window.TextMessage;
    await conversation.send(new TextMessage(text));
    addMsg({ from: myClientId, time: Date.now(), text });
  } catch (e) { console.error(e); }
}

document.getElementById("sendBtn").onclick = send;
document.getElementById("msgInput").onkeydown = (e) => e.key === "Enter" && send();

document.getElementById("pickBtn").onclick = () => document.getElementById("imgInput").click();

startIM();
</script>
</body>
</html>