<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å†…éƒ¨èŠå¤©å®¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { --blue:#1677ff; --bg:#f6f7f9; --card:#fff; --text:#1f2328; --muted:#8c8c8c; --border:#e6e6e6; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; }
    header{ background:var(--blue); color:#fff; padding:12px 14px; display:flex; align-items:center; justify-content:space-between; font-weight:700; }
    header small{ font-weight:500; opacity:.8; font-size: 11px; }

    #wrap{ flex:1; display:flex; flex-direction:column; padding:12px; gap:10px; min-height:0; }
    
    /* ç®¡ç†é¢æ¿æ ·å¼ï¼šé»˜è®¤éšè— */
    #adminPanel { background:#fffbe6; border:1px solid #ffe58f; border-radius:10px; padding:12px; display:none; flex-direction:column; gap:8px; margin-bottom:10px; }
    #adminPanel input { padding:8px; border:1px solid var(--border); border-radius:6px; font-size:13px; }
    
    #status{ background:var(--card); border:1px solid var(--border); border-radius:10px; padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px; }
    #status .left{ display:flex; align-items:center; gap:10px; min-width:0; }
    #badge{ width:10px; height:10px; border-radius:999px; background:#ff4d4f; flex:0 0 auto; }
    #statusText{ font-size:14px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #whoami{ font-size:13px; color:#fff; background:var(--blue); padding:6px 10px; border-radius:999px; flex:0 0 auto; }

    #chat{ flex:1; min-height:0; overflow-y:auto; background:var(--card); border:1px solid var(--border); border-radius:10px; padding:12px; }
    .msg{ display:flex; gap:10px; margin-bottom:10px; align-items:flex-start; }
    .avatar{ width:34px; height:34px; border-radius:999px; background:#e9f2ff; border:1px solid #d6e7ff; color:var(--blue);
      display:flex; align-items:center; justify-content:center; font-weight:800; flex:0 0 auto; }
    .bubble{ max-width:82%; background:#f7f7f7; border:1px solid var(--border); border-radius:12px; padding:8px 10px; line-height:1.35; word-break:break-word; }
    .meta{ font-size:12px; color:var(--muted); margin-bottom:4px; display:flex; gap:8px; align-items:baseline; }
    .meta .name{ color:#333; font-weight:700; }
    .meta .time{ color:var(--muted); }
    .text{ font-size:14px; white-space:pre-wrap; }
    .me{ flex-direction: row-reverse; }
    .me .meta{ flex-direction: row-reverse; }
    .me .avatar{ background:#1677ff; color:#fff; border-color:#1677ff; }
    .me .bubble{ background:#e8f1ff; border-color:#cfe1ff; }
    .sys{ margin:10px 0; text-align:center; color:var(--muted); font-size:12px; }
    .imgWrap img{ max-width:260px; border-radius:10px; display:block; margin-top:6px; border:1px solid var(--border); cursor:pointer; }

    footer{ background:var(--card); border:1px solid var(--border); border-radius:10px; padding:10px; display:flex; gap:8px; align-items:center; }
    #msgInput{ flex:1; padding:10px; font-size:14px; border:1px solid var(--border); border-radius:10px; outline:none; }
    #msgInput:focus{ border-color:#b9d3ff; }
    .btn{ padding:10px 12px; font-size:14px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer; transition: all .2s; }
    .btn.primary{ background:var(--blue); color:#fff; border-color:var(--blue); font-weight:700; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    #toggleAdmin { display:none; } /* é»˜è®¤éšè—ç®¡ç†æŒ‰é’® */
    #imgInput{ display:none; }
    .btn.icon{ width:44px; text-align:center; }
  </style>
</head>

<body>
<header>
  <div>å†…éƒ¨èŠå¤©å®¤</div>
  <small id="roomTag">CID: -</small>
</header>

<div id="wrap">
  <!-- ç®¡ç†é¢æ¿ -->
  <div id="adminPanel">
    <div style="font-weight:700; font-size:13px; color:#856404;">ğŸ› ï¸ ç®¡ç†å‘˜æ¨¡å¼ï¼šåˆ›å»ºæ–°é‚€è¯·</div>
    <input type="password" id="adminSecret" placeholder="ç®¡ç†å¯†é’¥ (CHAT_ADMIN_SECRET)" />
    <div style="display:flex; gap:8px;">
      <input type="text" id="newRoomName" placeholder="æ–°æˆ¿é—´åç§° (å¦‚ï¼šå¼€å‘å°ç»„)" style="flex:1" />
      <button class="btn primary" id="doCreateRoom">ç”Ÿæˆé“¾æ¥</button>
    </div>
  </div>

  <div id="status">
    <div class="left">
      <div id="badge"></div>
      <div id="statusText">å‡†å¤‡åŠ å…¥â€¦</div>
    </div>
    <div style="display:flex; gap:6px; align-items:center;">
      <button class="btn" style="font-size:11px; padding:4px 8px;" id="toggleAdmin">ç®¡ç†</button>
      <div id="whoami">-</div>
    </div>
  </div>

  <div id="chat"></div>

  <footer>
    <button class="btn icon" id="pickBtn" title="å‘é€å›¾ç‰‡">ğŸ–¼ï¸</button>
    <input id="msgInput" type="text" placeholder="è¾“å…¥æ¶ˆæ¯â€¦" />
    <button class="btn primary" id="sendBtn">å‘é€</button>
    <input id="imgInput" type="file" accept="image/*" />
  </footer>
</div>

<div id="viewer" onclick="hideViewer()"><img id="viewerImg" alt="preview"></div>

<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4/dist/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leancloud-realtime@5.0.0-rc.8/dist/im-browser.min.js"></script>

<script>
/* ========== é…ç½® ========== */
const APP_ID = "cf8fIUbJ0JZQmYfiihY6B1Fv-MdYXbMMI";
const APP_KEY = "UgnyTX8j3XGlfHPyGqPxgEB5";
const SERVER_URL = "https://cf8fiubj.api.lncldglobal.com";

AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });
const API_BASE = "https://chat-xyjdzs.avosapps.us";

/* ========== çŠ¶æ€ ========== */
const qs = new URLSearchParams(location.search);
const inviteCode = qs.get("invite") || "";
const urlNickname = qs.get("name") || ("guest_" + Math.random().toString(36).slice(2, 6));
const isAdminMode = qs.get("admin") === "1"; // æ˜¯å¦æ˜¯ç®¡ç†å‘˜è®¿é—®

let client = null;
let conversation = null;
let myClientId = "";

/* ========== DOM ========== */
const chatEl = document.getElementById("chat");
const statusTextEl = document.getElementById("statusText");
const badgeEl = document.getElementById("badge");
const whoamiEl = document.getElementById("whoami");
const roomTagEl = document.getElementById("roomTag");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const pickBtn = document.getElementById("pickBtn");
const imgInput = document.getElementById("imgInput");

/* ç®¡ç†ç›¸å…³ DOM */
const adminPanel = document.getElementById("adminPanel");
const toggleAdminBtn = document.getElementById("toggleAdmin");
const adminSecretInput = document.getElementById("adminSecret");
const newRoomNameInput = document.getElementById("newRoomName");
const doCreateRoomBtn = document.getElementById("doCreateRoom");

/* ========== åˆå§‹åŒ–ç®¡ç†å‘˜æƒé™ ========== */
if (isAdminMode) {
  toggleAdminBtn.style.display = "block"; // åªæœ‰ URL åŒ…å« ?admin=1 æ—¶æ˜¾ç¤ºç®¡ç†æŒ‰é’®
}

/* ========== å·¥å…·å‡½æ•° ========== */
function setStatus(text, ok=null) {
  statusTextEl.textContent = text;
  if (ok === null) return;
  badgeEl.style.background = ok ? "#52c41a" : "#ff4d4f";
}
function sys(text) {
  const div = document.createElement("div");
  div.className = "sys";
  div.textContent = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}
function avatarChar(name) {
  const s = (name || "?").trim();
  return s.length ? s[0].toUpperCase() : "?";
}
function fmtTime(ts) {
  const d = new Date(ts || Date.now());
  return `${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
}

const viewer = document.getElementById("viewer");
const viewerImg = document.getElementById("viewerImg");
function showViewer(url){ viewerImg.src = url; viewer.style.display = "flex"; }
function hideViewer(){ viewer.style.display = "none"; viewerImg.src = ""; }

function addMsg({ from, time, text }) {
  if (!text) return; 
  const row = document.createElement("div");
  row.className = "msg" + (from === myClientId ? " me" : "");
  const av = document.createElement("div");
  av.className = "avatar";
  av.textContent = avatarChar(from);
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerHTML = `<span class="name"></span><span class="time"></span>`;
  meta.querySelector(".name").textContent = from;
  meta.querySelector(".time").textContent = fmtTime(time);
  bubble.appendChild(meta);

  if (typeof text === "string" && text.startsWith("IMG:")) {
    const url = text.slice(4).trim();
    const wrap = document.createElement("div");
    wrap.className = "imgWrap";
    const img = document.createElement("img");
    img.src = url;
    img.onclick = () => showViewer(url);
    wrap.appendChild(img);
    bubble.appendChild(wrap);
  } else {
    const content = document.createElement("div");
    content.className = "text";
    content.textContent = text;
    bubble.appendChild(content);
  }
  row.appendChild(av);
  row.appendChild(bubble);
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

/* ========== API ========== */
async function redeemInvite() {
  const res = await fetch(API_BASE + "/api/invite/redeem", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ code: inviteCode, name: urlNickname })
  });
  if (!res.ok) throw new Error("é‚€è¯·ç éªŒè¯å¤±è´¥");
  return res.json();
}

async function getRTMSignature() {
  const res = await fetch(API_BASE + "/api/rtm/sign", {
    method: "POST",
    headers: { 
      "Authorization": "Bearer " + window.chatToken,
      "Content-Type": "application/json"
    }
  });
  if (!res.ok) throw new Error("è·å–ç­¾åå¤±è´¥");
  return res.json();
}

/* ========== IM é€»è¾‘ ========== */
async function start() {
  if (!inviteCode) {
    if (isAdminMode) {
      setStatus("ç®¡ç†å‘˜æ¨¡å¼å·²å¼€å¯", true);
      sys("ğŸ› ï¸ ç®¡ç†å‘˜æ¨¡å¼ï¼šè¯·ç‚¹å‡»â€œç®¡ç†â€æŒ‰é’®åˆ›å»ºæ–°æˆ¿é—´é‚€è¯·ã€‚");
    } else {
      setStatus("æœªæŒæœ‰æœ‰æ•ˆé‚€è¯·", false);
      sys("ğŸ‘‹ è¯·ä½¿ç”¨ç®¡ç†å‘˜æä¾›çš„ä¸“å±é‚€è¯·é“¾æ¥è¿›å…¥ã€‚");
    }
    return;
  }

  const RealtimeCtor = (window.AV && window.AV.Realtime) || window.Realtime || (window.LeanCloudRealtime && window.LeanCloudRealtime.Realtime);
  
  try {
    setStatus("éªŒè¯ä¸­...", null);
    const redeem = await redeemInvite();
    window.chatToken = redeem.chatToken;
    myClientId = redeem.clientId;
    whoamiEl.textContent = myClientId;

    setStatus("å»ºç«‹è¿æ¥...", null);
    const realtime = new RealtimeCtor({
      appId: APP_ID,
      appKey: APP_KEY,
      server: SERVER_URL,
      auth: getRTMSignature 
    });

    client = await realtime.createIMClient(myClientId);

    setStatus("åŒæ­¥æˆ¿é—´...", null);
    const query = client.getQuery().equalTo('name', redeem.room);
    const results = await query.find();
    
    if (results.length > 0) {
      conversation = results[0];
    } else {
      conversation = await client.createConversation({
        name: redeem.room,
        members: [],
        unique: false 
      });
    }

    roomTagEl.textContent = "Room: " + redeem.room;
    await conversation.join();
    setStatus("åœ¨çº¿", true);
    sys("âœ… å·²æˆåŠŸè¿›å…¥æˆ¿é—´ã€‚");

    client.on("message", (m, conv) => {
      if (conv.id === conversation.id && m.from !== myClientId && m.text) {
        addMsg({ from: m.from, time: m.timestamp, text: m.text });
      }
    });

    const msgs = await conversation.queryMessages({ limit: 30 });
    msgs.forEach(m => {
      if (m.text) addMsg({ from: m.from, time: m.timestamp, text: m.text });
    });

  } catch (err) {
    console.error(err);
    setStatus("ç¦»çº¿", false);
    sys("âŒ é”™è¯¯: " + err.message);
  }
}

/* ========== äº‹ä»¶ç»‘å®š ========== */
async function sendText() {
  if (!conversation) return;
  const text = msgInput.value.trim();
  if (!text) return;
  msgInput.value = "";
  try {
    const TextMessage = (window.AV && window.AV.TextMessage) || window.TextMessage;
    await conversation.send(new TextMessage(text));
    addMsg({ from: myClientId, time: Date.now(), text: text });
  } catch (e) { sys("âŒ å‘é€å¤±è´¥"); }
}

toggleAdminBtn.onclick = () => {
  const isShow = adminPanel.style.display === "flex";
  adminPanel.style.display = isShow ? "none" : "flex";
};

doCreateRoomBtn.onclick = async () => {
  const secret = adminSecretInput.value;
  const roomName = newRoomNameInput.value.trim();
  if (!secret || !roomName) return alert("è¯·å®Œæ•´å¡«å†™ç®¡ç†å¯†é’¥å’Œæˆ¿é—´å");

  try {
    doCreateRoomBtn.disabled = true;
    const res = await fetch(API_BASE + "/api/invite/create", {
      method: "POST",
      headers: { "Content-Type": "application/json", "x-admin-secret": secret },
      body: JSON.stringify({ room: roomName, ttlMinutes: 129600 })
    });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    
    // ç”Ÿæˆä¸€ä¸ªæ™®é€šç”¨æˆ·é“¾æ¥ï¼ˆä¸å¸¦ admin=1ï¼‰
    const baseUrl = window.location.origin + window.location.pathname;
    const userUrl = baseUrl + "?invite=" + data.code;
    
    sys("âœ¨ æˆ¿é—´åˆ›å»ºæˆåŠŸï¼é‚€è¯·ç : " + data.code);
    sys("ğŸ”— é‚€è¯·é“¾æ¥ (å‘ç»™åˆ«äºº):");
    const linkA = document.createElement("a");
    linkA.href = userUrl;
    linkA.textContent = userUrl;
    linkA.className = "sys-link";
    linkA.style.color = "#1677ff";
    chatEl.appendChild(linkA);
    chatEl.scrollTop = chatEl.scrollHeight;
    adminPanel.style.display = "none";
  } catch (e) {
    alert("åˆ›å»ºå¤±è´¥: " + e.message);
  } finally {
    doCreateRoomBtn.disabled = false;
  }
};

sendBtn.onclick = sendText;
msgInput.onkeydown = (e) => { if (e.key === "Enter") sendText(); };
pickBtn.onclick = () => imgInput.click();
imgInput.onchange = async () => {
  if (!conversation || !imgInput.files[0]) return;
  try {
    sys("â³ å›¾ç‰‡ä¸Šä¼ ä¸­...");
    const avFile = new AV.File(imgInput.files[0].name, imgInput.files[0]);
    await avFile.save();
    const TextMessage = (window.AV && window.AV.TextMessage) || window.TextMessage;
    await conversation.send(new TextMessage("IMG:" + avFile.url()));
    addMsg({ from: myClientId, time: Date.now(), text: "IMG:" + avFile.url() });
  } catch (e) { sys("âŒ å›¾ç‰‡å‘é€å¤±è´¥"); }
  imgInput.value = "";
};

start();
</script>
</body>
</html>